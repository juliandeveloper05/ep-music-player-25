<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EP Player - Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { height: 100vh; height: 100dvh; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .spin-slow { animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        input[type="range"] { -webkit-appearance: none; background: transparent; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px;
            border-radius: 50%; background: #ffffff; margin-top: -5px;
            cursor: pointer; box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px;
        }

        .eq-slider-container { position: relative; height: 120px; width: 30px; display: flex; align-items: center; justify-content: center; }
        .eq-slider {
            -webkit-appearance: none; width: 110px; height: 4px;
            background: #334155; outline: none; border-radius: 2px;
            transform: rotate(-90deg); transform-origin: center; cursor: pointer;
        }
        .eq-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            border-radius: 50%; background: #6366f1; cursor: pointer; border: 2px solid #1e293b; margin-top: -4px;
        }

        /* Animación para detección de instrumentos */
        .instrument-badge { transition: all 0.2s ease; opacity: 0.3; transform: scale(0.95); }
        .instrument-badge.active { opacity: 1; transform: scale(1); text-shadow: 0 0 10px rgba(99, 102, 241, 0.5); border-color: #6366f1; background-color: rgba(99, 102, 241, 0.1); }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 flex flex-col font-sans overflow-hidden">

    <!-- Header -->
    <header class="p-4 flex flex-col md:flex-row justify-between items-center border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-20 gap-3 flex-none">
        <div class="flex items-center gap-3 w-full md:w-auto">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                <i data-lucide="music" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-white tracking-tight">EP Player</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest">Stem Edition</p>
            </div>
        </div>
        
        <div class="flex flex-wrap justify-center gap-2">
            <button id="isolatorButton" onclick="toggleIsolator()" 
                    class="bg-slate-800 hover:bg-slate-700 text-slate-200 px-3 py-1.5 rounded-full text-xs font-medium transition-all flex items-center gap-2 border border-slate-700 shadow-md">
                <i data-lucide="layers" class="w-3 h-3"></i>
                <span>Aislar</span>
            </button>
            <button id="eqButton" onclick="toggleEQ()" 
                    class="bg-slate-800 hover:bg-slate-700 text-slate-200 px-3 py-1.5 rounded-full text-xs font-medium transition-all flex items-center gap-2 border border-slate-700 shadow-md">
                <i data-lucide="sliders-horizontal" class="w-3 h-3"></i>
                <span>EQ</span>
            </button>
            <button onclick="document.getElementById('coverInput').click()" 
                    class="bg-slate-800 hover:bg-slate-700 text-slate-200 px-3 py-1.5 rounded-full text-xs font-medium transition-all flex items-center gap-2 border border-slate-700">
                <i data-lucide="image"></i>
                <span>Portada</span>
            </button>
            <input type="file" id="coverInput" accept="image/*" class="hidden">
            <button onclick="document.getElementById('fileInput').click()" 
                    class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-full text-xs font-medium transition-all flex items-center gap-2 shadow-lg shadow-indigo-900/20">
                <i data-lucide="upload"></i>
                <span>Subir</span>
            </button>
            <input type="file" id="fileInput" multiple accept="audio/*" class="hidden">
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative min-h-0">
        
        <!-- EQ Panel (Overlay) -->
        <div id="eqPanel" class="hidden absolute top-16 right-4 md:right-20 z-30 bg-slate-900/95 backdrop-blur-xl border border-slate-700 p-4 rounded-2xl shadow-2xl w-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-indigo-400 font-bold text-xs uppercase flex items-center gap-2"><i data-lucide="sliders" class="w-3 h-3"></i> Ecualizador</h3>
                <button onclick="toggleEQ()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="flex gap-2 justify-center">
                 <!-- Sliders generated by JS logic, hardcoded here for layout -->
                 <div class="flex flex-col items-center gap-1"><div class="eq-slider-container"><input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" data-filter="0" oninput="updateEQ(0, this.value)"></div><span class="text-[9px] text-slate-400 font-mono">60</span></div>
                 <div class="flex flex-col items-center gap-1"><div class="eq-slider-container"><input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" data-filter="1" oninput="updateEQ(1, this.value)"></div><span class="text-[9px] text-slate-400 font-mono">250</span></div>
                 <div class="flex flex-col items-center gap-1"><div class="eq-slider-container"><input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" data-filter="2" oninput="updateEQ(2, this.value)"></div><span class="text-[9px] text-slate-400 font-mono">500</span></div>
                 <div class="flex flex-col items-center gap-1"><div class="eq-slider-container"><input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" data-filter="3" oninput="updateEQ(3, this.value)"></div><span class="text-[9px] text-slate-400 font-mono">1k</span></div>
                 <div class="flex flex-col items-center gap-1"><div class="eq-slider-container"><input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" data-filter="4" oninput="updateEQ(4, this.value)"></div><span class="text-[9px] text-slate-400 font-mono">4k</span></div>
                 <div class="flex flex-col items-center gap-1"><div class="eq-slider-container"><input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" data-filter="5" oninput="updateEQ(5, this.value)"></div><span class="text-[9px] text-slate-400 font-mono">10k</span></div>
            </div>
            <div class="mt-2 text-center"><button onclick="resetEQ()" class="text-[9px] text-slate-500 hover:text-white underline">Reset</button></div>
        </div>

        <!-- Isolator Panel (Overlay) -->
        <div id="isolatorPanel" class="hidden absolute top-16 left-4 md:left-20 z-30 bg-slate-900/95 backdrop-blur-xl border border-slate-700 p-4 rounded-2xl shadow-2xl w-64">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-indigo-400 font-bold text-xs uppercase flex items-center gap-2"><i data-lucide="layers" class="w-3 h-3"></i> Aislador de Stems</h3>
                <button onclick="toggleIsolator()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="space-y-2">
                <button onclick="setStemMode('normal')" class="w-full text-left px-3 py-2 rounded bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-500 transition-colors stem-btn" id="btn-normal">
                    Original (Mix Completo)
                </button>
                <div class="h-px bg-slate-700 my-2"></div>
                <button onclick="setStemMode('bass')" class="w-full text-left px-3 py-2 rounded bg-slate-800 text-slate-300 text-xs hover:bg-slate-700 transition-colors stem-btn flex justify-between" id="btn-bass">
                    <span>Bajos / Sub</span> <i data-lucide="activity" class="w-3 h-3"></i>
                </button>
                <button onclick="setStemMode('drums')" class="w-full text-left px-3 py-2 rounded bg-slate-800 text-slate-300 text-xs hover:bg-slate-700 transition-colors stem-btn flex justify-between" id="btn-drums">
                    <span>Batería / Ritmo</span> <i data-lucide="drum" class="w-3 h-3"></i>
                </button>
                <button onclick="setStemMode('vocals')" class="w-full text-left px-3 py-2 rounded bg-slate-800 text-slate-300 text-xs hover:bg-slate-700 transition-colors stem-btn flex justify-between" id="btn-vocals">
                    <span>Voces / Lead</span> <i data-lucide="mic" class="w-3 h-3"></i>
                </button>
                <button onclick="setStemMode('mids')" class="w-full text-left px-3 py-2 rounded bg-slate-800 text-slate-300 text-xs hover:bg-slate-700 transition-colors stem-btn flex justify-between" id="btn-mids">
                    <span>Piano / Guitarra</span> <i data-lucide="music-2" class="w-3 h-3"></i>
                </button>
            </div>
            <p class="text-[9px] text-slate-500 mt-3 text-center italic">
                *Simulación basada en frecuencias.
            </p>
        </div>

        <!-- Player Visual Section -->
        <section class="flex-1 flex flex-col items-center justify-center p-4 bg-gradient-to-b from-slate-900 to-slate-950 relative z-10 overflow-y-auto md:overflow-hidden">
            
            <!-- Instrument Detection Badges -->
            <div class="flex gap-2 mb-6 flex-wrap justify-center" id="instrumentDetector">
                <div class="instrument-badge border border-slate-700 px-2 py-1 rounded-full text-[9px] font-bold text-slate-300 flex items-center gap-1" id="badge-bass">
                    <div class="w-1.5 h-1.5 rounded-full bg-indigo-500"></div> BASS
                </div>
                <div class="instrument-badge border border-slate-700 px-2 py-1 rounded-full text-[9px] font-bold text-slate-300 flex items-center gap-1" id="badge-kick">
                    <div class="w-1.5 h-1.5 rounded-full bg-red-500"></div> KICK
                </div>
                <div class="instrument-badge border border-slate-700 px-2 py-1 rounded-full text-[9px] font-bold text-slate-300 flex items-center gap-1" id="badge-vocals">
                    <div class="w-1.5 h-1.5 rounded-full bg-yellow-500"></div> VOX
                </div>
                <div class="instrument-badge border border-slate-700 px-2 py-1 rounded-full text-[9px] font-bold text-slate-300 flex items-center gap-1" id="badge-highs">
                    <div class="w-1.5 h-1.5 rounded-full bg-cyan-500"></div> HI-HAT
                </div>
            </div>

            <!-- Visualizer / Album Art Container -->
            <div class="relative w-48 h-48 md:w-64 md:h-64 mb-4 group shrink-0 cursor-pointer" onclick="togglePlay()">
                <div class="absolute inset-0 bg-indigo-500 rounded-full blur-3xl opacity-20 group-hover:opacity-30 transition-opacity duration-500"></div>
                
                <div id="albumArt" class="w-full h-full bg-slate-800 rounded-full border-4 border-slate-700 shadow-2xl flex items-center justify-center overflow-hidden relative transition-transform duration-700">
                    <div id="albumCoverImage" class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=1000&auto=format&fit=crop')] bg-cover bg-center opacity-40 transition-opacity duration-300"></div>
                    
                    <div id="discCenter" class="w-16 h-16 bg-slate-950 rounded-full border-4 border-slate-700 z-30 flex items-center justify-center">
                        <i id="playStateIcon" data-lucide="play" class="w-6 h-6 text-slate-500 ml-1"></i>
                    </div>
                </div>
            </div>

            <!-- Song Info & Controls -->
            <div class="text-center w-full max-w-md shrink-0 flex flex-col gap-2">
                <div>
                    <h2 id="currentTitle" class="text-lg font-bold text-white truncate px-4">Esperando música...</h2>
                    <p id="currentOrder" class="text-slate-400 text-xs">Sube archivos para comenzar</p>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full flex items-center gap-2 px-2">
                    <span id="currentTime" class="text-[10px] text-slate-400 w-8 text-right font-mono">0:00</span>
                    <div class="flex-1 relative h-1 bg-slate-700 rounded-full cursor-pointer group py-2 bg-clip-content" id="progressContainer">
                        <div class="absolute top-2 left-0 right-0 h-1 bg-slate-700 rounded-full"></div>
                        <div id="progressBar" class="absolute top-2 left-0 h-1 bg-indigo-500 rounded-full w-0 group-hover:bg-indigo-400 transition-colors"></div>
                    </div>
                    <span id="duration" class="text-[10px] text-slate-400 w-8 text-left font-mono">0:00</span>
                </div>

                <!-- CONTROLES -->
                <div class="flex items-center justify-center gap-6 mt-1">
                    <button id="prevBtn" class="text-slate-400 hover:text-white transition-colors disabled:opacity-30 p-2">
                        <i data-lucide="skip-back" class="w-6 h-6"></i>
                    </button>
                    
                    <button id="playBtn" class="w-12 h-12 bg-white text-slate-900 rounded-full flex items-center justify-center hover:scale-105 transition-transform shadow-lg shadow-white/10 mx-2">
                        <i data-lucide="play" class="w-5 h-5 fill-current ml-1"></i>
                    </button>
                    
                    <button id="nextBtn" class="text-slate-400 hover:text-white transition-colors disabled:opacity-30 p-2">
                        <i data-lucide="skip-forward" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="flex items-center justify-center gap-2 w-2/3 mx-auto mt-1">
                    <i data-lucide="volume-2" class="w-3 h-3 text-slate-400"></i>
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </section>

        <!-- Playlist Section -->
        <section class="w-full md:w-80 bg-slate-900 border-l border-slate-800 flex flex-col z-10 h-1/3 md:h-auto border-t md:border-t-0 shrink-0">
            <div class="p-3 border-b border-slate-800 flex-none flex justify-between items-center">
                <h3 class="font-semibold text-slate-200 flex items-center gap-2 text-sm">
                    <i data-lucide="list-music" class="w-4 h-4"></i>
                    Lista
                </h3>
                <span id="trackCount" class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-400">0</span>
            </div>
            
            <div id="playlistContainer" class="flex-1 overflow-y-auto p-2 space-y-1 pb-2">
                <div id="emptyState" class="h-full flex flex-col items-center justify-center text-slate-500 p-4 text-center opacity-60">
                    <i data-lucide="music-4" class="w-8 h-8 mb-1"></i>
                    <p class="text-xs">Lista vacía</p>
                </div>
            </div>
            
            <div class="p-2 bg-slate-900 border-t border-slate-800 text-[10px] text-slate-500 text-center flex-none">
                Total: <span id="totalDuration" class="text-slate-300">0:00</span>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="p-4 border-t border-slate-800 bg-slate-900/90 backdrop-blur-md text-center text-xs text-slate-400 font-medium flex-none z-20 pb-6 md:pb-4">
        Developed by Julian Javier Soto from Argentina with love ❤️
    </footer>

    <script>
        // --- CONFIGURACIÓN & VARIABLES ---
        function initIcons() { if (typeof lucide !== 'undefined') lucide.createIcons(); }
        document.addEventListener('DOMContentLoaded', initIcons);
        window.addEventListener('load', initIcons);

        const audio = new Audio();
        audio.crossOrigin = "anonymous";
        let playlist = [];
        let currentIndex = 0;
        let isPlaying = false;
        let currentCoverUrl = null;

        // Variables Audio Context
        let audioContext, audioSource, analyser;
        let eqFilters = [];
        let isolatorFilter = null; // Filtro dinámico para stems
        let animationId;
        const frequencies = [60, 250, 500, 1000, 4000, 10000];

        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const coverInput = document.getElementById('coverInput');
        const playBtn = document.getElementById('playBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const volumeSlider = document.getElementById('volumeSlider');
        const playlistContainer = document.getElementById('playlistContainer');
        const currentTitleEl = document.getElementById('currentTitle');
        const currentOrderEl = document.getElementById('currentOrder');
        const trackCountEl = document.getElementById('trackCount');
        const totalDurationEl = document.getElementById('totalDuration');
        const emptyState = document.getElementById('emptyState');
        const albumArt = document.getElementById('albumArt');
        const albumCoverImage = document.getElementById('albumCoverImage');
        const playStateIcon = document.getElementById('playStateIcon');
        const eqPanel = document.getElementById('eqPanel');
        const isolatorPanel = document.getElementById('isolatorPanel');

        // --- SISTEMA DE AUDIO (CONTEXT & NODOS) ---

        function setupAudioContext() {
            if (audioContext) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
            audioSource = audioContext.createMediaElementSource(audio);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256; // Para detección visual rápida

            // 1. Nodo Aislador (Stem Isolator)
            // Se usará un filtro Biquad que cambiará dinámicamente
            isolatorFilter = audioContext.createBiquadFilter();
            isolatorFilter.type = 'allpass'; // Por defecto no hace nada (o paso todo)
            
            // 2. Nodos EQ (Gráfico)
            eqFilters = frequencies.map((freq, index) => {
                const filter = audioContext.createBiquadFilter();
                if (index === 0) filter.type = 'lowshelf';
                else if (index === frequencies.length - 1) filter.type = 'highshelf';
                else { filter.type = 'peaking'; filter.Q.value = 1.0; }
                filter.frequency.value = freq;
                filter.gain.value = 0;
                return filter;
            });

            // Conexiones: Source -> Isolator -> EQ Chain -> Analyser -> Destination
            audioSource.connect(isolatorFilter);
            
            let currentNode = isolatorFilter;
            eqFilters.forEach(filter => {
                currentNode.connect(filter);
                currentNode = filter;
            });
            
            currentNode.connect(analyser);
            analyser.connect(audioContext.destination);

            startVisualizer();
        }

        // --- LÓGICA DE AISLAMIENTO DE STEMS ---

        function setStemMode(mode) {
            if (!audioContext) setupAudioContext();
            
            // Resetear botones visualmente
            document.querySelectorAll('.stem-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-slate-800', 'text-slate-300');
            });
            const activeBtn = document.getElementById(`btn-${mode}`);
            if(activeBtn) {
                activeBtn.classList.remove('bg-slate-800', 'text-slate-300');
                activeBtn.classList.add('bg-indigo-600', 'text-white');
            }

            // Aplicar filtros
            const currentTime = audioContext.currentTime;
            
            // Suavizar transición
            isolatorFilter.gain.cancelScheduledValues(currentTime);
            isolatorFilter.frequency.cancelScheduledValues(currentTime);
            isolatorFilter.Q.cancelScheduledValues(currentTime);

            switch (mode) {
                case 'bass': // Pasa-bajos agresivo
                    isolatorFilter.type = 'lowpass';
                    isolatorFilter.frequency.setTargetAtTime(200, currentTime, 0.1);
                    isolatorFilter.Q.value = 1;
                    break;
                case 'drums': // Enfatizar kick y brillo, cortar medios
                    // Nota: Con un solo filtro es difícil hacer la V, usamos notch para matar medios
                    isolatorFilter.type = 'notch'; 
                    isolatorFilter.frequency.setTargetAtTime(500, currentTime, 0.1);
                    isolatorFilter.Q.value = 0.5; // Ancho de banda amplio
                    break;
                case 'vocals': // Pasa-banda en rango vocal
                    isolatorFilter.type = 'bandpass';
                    isolatorFilter.frequency.setTargetAtTime(1000, currentTime, 0.1);
                    isolatorFilter.Q.value = 0.8; // Ancho para captar cuerpo
                    break;
                case 'mids': // Medios altos (pianos, guitarras)
                    isolatorFilter.type = 'bandpass';
                    isolatorFilter.frequency.setTargetAtTime(2500, currentTime, 0.1);
                    isolatorFilter.Q.value = 1;
                    break;
                default: // Normal
                    isolatorFilter.type = 'allpass'; // Deja pasar todo
                    isolatorFilter.frequency.value = 350;
                    break;
            }
            
            // Cerrar panel después de elegir (opcional, mejor dejarlo abierto para jugar)
            // toggleIsolator(); 
        }

        function toggleIsolator() {
            isolatorPanel.classList.toggle('hidden');
            eqPanel.classList.add('hidden'); // Cerrar EQ si se abre isolator
        }

        function toggleEQ() {
            eqPanel.classList.toggle('hidden');
            isolatorPanel.classList.add('hidden'); // Cerrar isolator si se abre EQ
            initIcons();
        }

        window.updateEQ = function(index, value) {
            if (!audioContext) setupAudioContext();
            if (eqFilters[index]) eqFilters[index].gain.value = parseFloat(value);
        };

        window.resetEQ = function() {
            document.querySelectorAll('.eq-slider').forEach(s => { s.value = 0; updateEQ(s.dataset.filter, 0); });
        };

        // --- DETECTOR DE INSTRUMENTOS (VISUALIZER) ---

        function startVisualizer() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            const badges = {
                bass: document.getElementById('badge-bass'),
                kick: document.getElementById('badge-kick'),
                vocals: document.getElementById('badge-vocals'),
                highs: document.getElementById('badge-highs')
            };

            function draw() {
                animationId = requestAnimationFrame(draw);
                if (!isPlaying) return;

                analyser.getByteFrequencyData(dataArray);

                // Calcular energía promedio en bandas específicas
                // Bin size approx = 44100 / 256 = ~172Hz por bin (muy ancho, pero sirve para demo)
                // Usando índices aproximados
                
                let bassEnergy = 0;
                for(let i=0; i<3; i++) bassEnergy += dataArray[i]; // ~0-500Hz
                bassEnergy /= 3;

                let kickEnergy = dataArray[0]; // Muy bajos ~0-170Hz

                let vocalEnergy = 0; 
                for(let i=3; i<10; i++) vocalEnergy += dataArray[i]; // ~500-1700Hz
                vocalEnergy /= 7;

                let highEnergy = 0;
                for(let i=30; i<60; i++) highEnergy += dataArray[i]; // ~5kHz+
                highEnergy /= 30;

                // Thresholds visuales (ajustables)
                toggleBadge(badges.bass, bassEnergy > 180);
                toggleBadge(badges.kick, kickEnergy > 210);
                toggleBadge(badges.vocals, vocalEnergy > 140);
                toggleBadge(badges.highs, highEnergy > 100);
            }
            draw();
        }

        function toggleBadge(el, isActive) {
            if(isActive) el.classList.add('active');
            else el.classList.remove('active');
        }

        // --- FUNCIONES CORE DEL PLAYER ---

        function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            currentIndex = index;
            const track = playlist[index];
            audio.src = track.url;
            audio.load();
            currentTitleEl.textContent = track.name;
            currentOrderEl.textContent = `Pista ${index + 1} de ${playlist.length}`;
            progressBar.style.width = '0%';
            currentTimeEl.textContent = '0:00';
            updatePlaylistUI();
            updateMediaSession();
        }

        function playTrack(index) {
            if (index !== currentIndex) loadTrack(index);
            setTimeout(() => togglePlay(true), 100);
        }

        function togglePlay(forcePlay = null) {
            if (playlist.length === 0) return;
            const shouldPlay = forcePlay !== null ? forcePlay : !isPlaying;
            if (shouldPlay) {
                if (!audioContext) setupAudioContext();
                if (audioContext && audioContext.state === 'suspended') audioContext.resume();
                audio.play().catch(e => console.error(e));
            } else {
                audio.pause();
            }
        }

        // --- UI & EVENTOS ---

        function updatePlayBtnState() {
            const icon = isPlaying ? 'pause' : 'play';
            playBtn.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 fill-current ml-${isPlaying ? '0' : '1'}"></i>`;
            
            // Icono centro del disco
            playStateIcon.setAttribute('data-lucide', icon);
            playStateIcon.classList.remove('ml-1', 'ml-0');
            playStateIcon.classList.add(isPlaying ? 'ml-0' : 'ml-1');
            
            initIcons();
            
            if (isPlaying) {
                albumArt.classList.add('spin-slow');
                albumArt.style.animationPlayState = 'running';
            } else {
                albumArt.style.animationPlayState = 'paused';
            }
        }

        audio.addEventListener('play', () => { isPlaying = true; updatePlayBtnState(); updatePlaylistUI(); });
        audio.addEventListener('pause', () => { isPlaying = false; updatePlayBtnState(); updatePlaylistUI(); });
        audio.addEventListener('ended', () => {
            if (currentIndex < playlist.length - 1) playTrack(currentIndex + 1);
            else { isPlaying = false; updatePlayBtnState(); currentIndex = 0; loadTrack(0); }
        });
        
        audio.addEventListener('timeupdate', () => {
            if (audio.duration) {
                const percent = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = `${percent}%`;
                currentTimeEl.textContent = formatTime(audio.currentTime);
                durationEl.textContent = formatTime(audio.duration);
            }
        });

        // Controles básicos
        playBtn.onclick = () => togglePlay();
        prevBtn.onclick = () => {
            if (audio.currentTime > 3) audio.currentTime = 0;
            else if (currentIndex > 0) playTrack(currentIndex - 1);
        };
        nextBtn.onclick = () => { if (currentIndex < playlist.length - 1) playTrack(currentIndex + 1); };
        
        progressContainer.onclick = (e) => {
            if (playlist.length === 0) return;
            audio.currentTime = (e.offsetX / progressContainer.clientWidth) * audio.duration;
        };
        volumeSlider.oninput = (e) => audio.volume = e.target.value;

        // Archivos
        fileInput.onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            for (const file of files) {
                const url = URL.createObjectURL(file);
                const duration = await getAudioDuration(url);
                playlist.push({ name: file.name.replace(/\.[^/.]+$/, ""), url, duration });
            }
            updatePlaylistUI();
            updateTotalDuration();
            if (playlist.length === files.length) loadTrack(0);
        };

        const getAudioDuration = (url) => new Promise(resolve => {
            const a = new Audio(url);
            a.onloadedmetadata = () => resolve(a.duration);
            a.onerror = () => resolve(0);
        });

        coverInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                currentCoverUrl = URL.createObjectURL(file);
                albumCoverImage.style.backgroundImage = `url('${currentCoverUrl}')`;
                albumCoverImage.classList.remove('opacity-40');
                albumCoverImage.classList.add('opacity-80');
                updateMediaSession();
            }
        };

        function updatePlaylistUI() {
            if (playlist.length > 0) emptyState.style.display = 'none';
            playlistContainer.innerHTML = '';
            playlist.forEach((track, index) => {
                const isActive = index === currentIndex;
                const item = document.createElement('div');
                item.className = `p-2 rounded-lg flex items-center gap-2 cursor-pointer transition-colors group ${isActive ? 'bg-indigo-900/50 border border-indigo-500/30' : 'hover:bg-slate-800 border border-transparent'}`;
                item.innerHTML = `
                    <div class="text-[10px] font-mono ${isActive ? 'text-indigo-400' : 'text-slate-500'} w-4 text-center flex-shrink-0">${index + 1}</div>
                    <div class="flex-1 min-w-0"><div class="font-medium text-xs truncate ${isActive ? 'text-indigo-200' : 'text-slate-300 group-hover:text-white'}">${track.name}</div></div>
                    <div class="text-[10px] text-slate-500 font-mono">${formatTime(track.duration)}</div>
                `;
                item.onclick = () => playTrack(index);
                playlistContainer.appendChild(item);
            });
            trackCountEl.textContent = playlist.length;
        }

        function updateTotalDuration() {
            totalDurationEl.textContent = formatTime(playlist.reduce((acc, t) => acc + (t.duration || 0), 0));
        }

        function formatTime(s) {
            if (!s || isNaN(s)) return "0:00";
            const m = Math.floor(s / 60);
            const sc = Math.floor(s % 60);
            return `${m}:${sc < 10 ? '0' : ''}${sc}`;
        }

        function updateMediaSession() {
            if ('mediaSession' in navigator && playlist[currentIndex]) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: playlist[currentIndex].name,
                    artist: 'Mi EP',
                    album: 'Reproductor Local',
                    artwork: [{ src: currentCoverUrl || 'https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=512', sizes: '512x512', type: 'image/jpeg' }]
                });
            }
        }
    </script>
</body>
</html>